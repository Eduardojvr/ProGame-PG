<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>ProGame</title>

<link
	href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900"
	rel="stylesheet">
<link
	href="https://cdn.jsdelivr.net/npm/@mdi/font@4.x/css/materialdesignicons.min.css"
	rel="stylesheet">
<!-- <link
	href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css"
	rel="stylesheet"> -->

<link
	href="https://fonts.googleapis.com/css?family=Montserrat:400,700,200"
	rel="stylesheet" />
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" />

<link href="../resources/css/bootstrap.min.css" rel="stylesheet" />
<link href="../resources/css/light-bootstrap-dashboard.css?v=2.0.0 "
	rel="stylesheet" />

<link href="../resources/css/demo.css" rel="stylesheet" />
<link type="text/css" rel="stylesheet"
	href="//unpkg.com/bootstrap/dist/css/bootstrap.min.css" />
<link type="text/css" rel="stylesheet"
	href="//unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.css" />
</head>
<body>

	<!-- INICIO MODAL -->
	<div style="padding-left: 15%; background-color: rgba(0, 0, 0, 0.6);"
		class="modal fade right" id="modalInicio" tabindex="-1" role="dialog"
		aria-labelledby="myModalLabel" aria-hidden="true"
		data-backdrop="static" data-keyboard="false">
		<div
			class="modal-dialog modal-side modal-bottom-right modal-notify modal-info"
			role="document">
			<!--Content-->
			<div class="modal-content">

				<!--Body-->
				<div class="modal-body"
					style="background-color: rgba(192, 192, 192, 0.5)">

					<div class="row">
						<div class="col-5">
							<img src="../resources/img/aisha.png" class="img-fluid" alt="">
						</div>

						<div class="col-7" id="gerenciapersonagem">
							<p>
								<strong>Bem vindo ao modo 1 VS 1</strong>
							</p>
							<p>
								Desafie outros jogadores a solucionarem problemas criados por
								você e conquiste mais pontos. <br> Ao propor ou resolver um
								desafio, você automaticamente recebe 100 pontos.<br>Conferir
								a resposta dada por seu adversário duplica seus ganhos.<br>
								<br>Bom jogo!
							</p>
							<br>
							<div style="padding-left: 12%;">
								<button type="button" class="btn btn-info btn-md"
									onclick='$("#modalInicio").modal("hide");'>Ok</button>
							</div>

						</div>
					</div>
				</div>
			</div>
			<!--/.Content-->
		</div>
	</div>
	<!-- FIM MODAL -->
	<div id="batalha">

		<div
		style="padding-left: 15%; padding-right: 60px; background-color: rgba(0, 0, 0, 0.6);"
		id="feedbackResposta" class="modal fade top" tabindex="-1" role="dialog"
		 aria-hidden="true" data-backdrop='false'
		data-keyboard="false">
		<div class="modal-dialog modal-lg modal-frame modal-top"
			role="document">
			<div style="background-color: rgba(255, 255, 255, 0.9);"
				class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"
						aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<div style="text-align: center;">
						<h3>Resposta registrada com sucesso!</h3>
					</div>
					<div class="row">
						<div class="col-3">
							<img height="250" width="200" src="../resources/img/orcDancando.gif" alt="">
						</div>
						<div style="padding-left: 40px; padding-top: 5%;" class="col-8">
							<h4>Você acaba de receber 100 pontos de experiência por responder um desafio!<br>Aguarde a correção e feedback do desafiante!</h4>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

		<div
		style="padding-left: 15%; padding-right: 60px; background-color: rgba(0, 0, 0, 0.6);"
		id="feedbackAvalia" class="modal fade top" tabindex="-1" role="dialog"
		 aria-hidden="true" data-backdrop='false'
		data-keyboard="false">
		<div class="modal-dialog modal-lg modal-frame modal-top"
			role="document">
			<div style="background-color: rgba(255, 255, 255, 0.9);"
				class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"
						aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<div style="text-align: center;">
						<h3>Avaliação registrada com sucesso!</h3>
					</div>
					<div class="row">
						<div class="col-3">
							<img height="250" width="200" src="../resources/img/orcAnimado.gif" alt="">
						</div>
						<div style="padding-left: 40px; padding-top: 5%;" class="col-8">
							<h4>Você acaba de receber 100 pontos de experiência por avaliar a resposta de outro jogador!</h4>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

		<div class="modal fade" id="modalResposta" tabindex="-1" role="dialog"
			aria-labelledby="exampleModalLabel" aria-hidden="true">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h3 style="color: steelblue;" class="modal-title"
							id="myModalLabel">Desafio</h3>
						<button type="button" class="close" data-dismiss="modal"
							aria-label="Close">
							<span aria-hidden="true">×</span>
						</button>
					</div>
					<div class="modal-body">
						<label>Digite sua resposta</label>
						<textarea style="border-radius: 10px;" cols="47" rows="6"
							v-model="minhaResposta"></textarea>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary"
							data-dismiss="modal">Cancelar</button>
						<button type="button" class="btn btn-primary" data-dismiss="modal"
							@click="responde()">Salvar</button>
					</div>
				</div>
			</div>
		</div>

		<div
			style="padding-left: 15%; padding-right: 60px; background-color: rgba(0, 0, 0, 0.6);"
			id="pvsp" class="modal fade top" tabindex="-1" role="dialog"
			aria-labelledby="pvsp" aria-hidden="true" data-backdrop='false'
			data-keyboard="false">
			<div class="modal-dialog modal-lg modal-frame modal-top"
				role="document">
				<div style="background-color: rgba(255, 255, 255, 0.9);"
					class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal"
							aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<div style="text-align: center;">
							<h3>Desafio enviado! Você recebeu 100 pontos!</h3>
						</div>
						<div class="row">
							<div class="col-3">
								<img height="250" width="200" v-bind:src="desafiante" alt="">

							</div>
							<div class="col-3">
								<audio src="../resources/sons/misterio.mp3"></audio>
								<img width="250" height="250" style="padding-left: 30px;"
									src="../resources/img/vs.gif" alt="">
							</div>
							<div class="col-3" style="padding-left: 150px;">
								<img height="250" width="200" v-bind:src="desafiado" alt="">
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>


		<div style="padding-left: 15%; background-color: rgba(0, 0, 0, 0.6);"
			class="modal fade top" tabindex="-1" role="dialog" aria-hidden="true"
			data-backdrop='false' id="modalBatalha">
			<div class="modal-dialog modal-lg modal-frame modal-top"
				role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h3 style="color: steelblue;" class="modal-title">Batalha 1
							vs 1</h3>
						<button type="button" class="close" data-dismiss="modal"
							aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<label style="padding-left: 13%;">Título do Desafio</label><br>
						<div style="text-align: center;">
							<input style="border-radius: 10px;" type="text" name="nome"
								size="60" v-model="tituloDesafio"> <br /> <br />
						</div>

						<label style="padding-left: 13%;">Desafio</label><br>
						<div style="text-align: center;">
							<textarea style="border-radius: 10px;" name="descricao" rows="5"
								cols="60" v-model="desafio"></textarea>
							<br />
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary"
							data-dismiss="modal">Cancelar</button>
						<button type="button" class="btn btn-primary" data-dismiss="modal"
							@click="salvaDesafio()">Salvar</button>
					</div>
				</div>
			</div>
		</div>
		<div class="modal fade" id="modalAnalise" tabindex="-1" role="dialog"
			aria-labelledby="exampleModalLabel" aria-hidden="true">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h3 style="color: steelblue;" class="modal-title"
							id="myModalLabel">Correção</h3>
						<button type="button" class="close" data-dismiss="modal"
							aria-label="Close">
							<span aria-hidden="true">×</span>
						</button>
					</div>
					<div class="modal-body">
						<label>Avaliação: &nbsp; </label> <select v-model="correcaoOpcao">
							<option value="c">Certo</option>
							<option value="e">Errado</option>
						</select> <br>
						<br> <label>Digite suas observações</label>
						<textarea style="border-radius: 10px;" cols="47" rows="6"
							v-model="correcaoAvalia"></textarea>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary"
							data-dismiss="modal">Cancelar</button>
						<button type="button" class="btn btn-primary" data-dismiss="modal"
							@click="salvaAvaliacao()">Salvar</button>
					</div>
				</div>
			</div>
		</div>
		<div class="wrapper">
			<div id="menu"></div>

			<div class="main-panel">
				<div class="container">
					<div class="tabela">
						<hr>
						<h2 style="text-align: center;">Modo 1 VS 1</h2>
						<hr>
						<br> <br>
						<div>
							<h3 style="text-align: left;">🏆 Desafie outros jogadores</h3>
							<div class="overflow-auto">
								<b-table @row-clicked="batalha" :fields="headers"
									:items="usuarios" :per-page="perPage"
									:current-page="currentPage" striped bordered hover responsive></b-table>
								<div style="padding-left: 30%;">
									<b-pagination v-model="currentPage" :total-rows="rowDesafio"
										:per-page="perPage" prev-text="◀︎" next-text="▶︎" class="mt-4"
										pills></b-pagination>
								</div>
							</div>
						</div>
					</div>

					<br>
					<hr>
					<br>
					<div class="tabela">

						<h3 style="text-align: left;">🏆 Desafios recebidos</h3>

						<div class="table-responsive-sm">
							<b-table @row-clicked="abreModalResposta" id="my-table"
								:fields="headersDesafios" :items="desafios" :per-page="perPage"
								:current-page="currentPageDesafios" striped bordered hover  sticky-header ></b-table>
							<div style="padding-left: 30%;">
								<b-pagination v-model="currentPageDesafios" :total-rows="rows"
									:per-page="perPage" prev-text="◀︎" next-text="▶︎" class="mt-4"
									pills></b-pagination>
							</div>
						</div>
					</div>

					<br>
					<hr>
					<br>
					<div class="tabela">
						<h3 style="text-align: left;">🏆 Desafios Enviados</h3>
						<div class="overflow-auto">
							<b-table  @row-clicked="avalia" id="my-table-correcao" :fields="headersDesafiosCorrecao"
								:items="desafiosCorrecao" :per-page="perPage"
								:current-page="currentPageCorrecao" bordered striped  hover responsive ></b-table>
							<div style="padding-left: 30%;">
								<b-pagination v-model="currentPageCorrecao"
									:total-rows="rowsCorrecao" :per-page="perPage" prev-text="◀︎"
									next-text="▶︎" class="mt-4" pills></b-pagination>
							</div>
						</div>
					</div>
				</div>

			</div>

		</div>

	</div>





	<script src="../resources/js/vue.js"></script>
	<script src="../resources/js/axios.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
	<script src="../resources/js/core/jquery.3.2.1.min.js"
		type="text/javascript"></script>
	<script src="../resources/js/core/popper.min.js" type="text/javascript"></script>
	<script src="../resources/js/core/bootstrap.min.js"
		type="text/javascript"></script>
	<!--  Plugin for Switches, full documentation here: http://www.jque.re/plugins/version3/bootstrap.switch/ -->
	<script src="../resources/js/plugins/bootstrap-switch.js"></script>
	<!--  Chartist Plugin  -->
	<script src="../resources/js/plugins/chartist.min.js"></script>
	<!--  Notifications Plugin    -->
	<script src="../resources/js/plugins/bootstrap-notify.js"></script>
	<!-- Control Center for Light Bootstrap Dashboard: scripts for the example pages etc -->
	<script src="../resources/js/light-bootstrap-dashboard.js?v=2.0.0 "
		type="text/javascript"></script>
	<!-- Light Bootstrap Dashboard DEMO methods, don't include it in your project! -->
	<script src="../resources/js/demo.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/vue@2.5.17/dist/vue.min.js"></script>
	<script src="//unpkg.com/babel-polyfill@latest/dist/polyfill.min.js"></script>
	<script src="//unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.js"></script>
	<!-- <script src="../resources/js/notifica.js" ></script> -->



	<script> 
new Vue({
  el: '#batalha',
  vuetify: new Vuetify(),
  data () {
    return {
      search: '',
      headers: [
            {
                sortable: false,
                key: "posicao",
                label: "Posição"
            },
            {
                sortable: false,
                key: "nomeUsuario",
                label: "Usuário"
            },
            {
                sortable: true,
                key: "pontuacao",
                label: "Pontuação"
            },
            {
                sortable: true,
                key: "level",
                label: "Level"
            }
      ],
      usuarios: [],
      pontos : '',
      matricula : '',
      posicaojogador: '',
      totalJogadores: 0,  
      desafiante: '',
      desafiado: '',
      desafio:'',
      tituloDesafio: '',
	  matriculaDesafiado: '',
	  perPage: 5,
	  currentPage: 1,
	  currentPageDesafios: 1,
	  currentPageCorrecao: 1,
      headersDesafios: [
            {
              align: 'left',
              sortable: false,
            },
            // { key: 'idDesafio', label: 'Prioridade Desafio' },
            { key: 'tituloDesafio', label: 'Título' },
            { key: 'desafio', label: 'Desafio' },
            { key: 'respostaDesafiado', label: 'Sua resposta', sortable: true },
			{ key: 'resultado', label: 'Resultado',  sortable: true  },
			{ key: 'avaliacao', label: 'Feedback' }
       ],
      desafios:[
          {
              desafio: '',
              idDesafio: '',
              matriculaDesafiado: '',
              matriculaDesafiante: '',
              respostaDesafiado: '',
              resultado: '',
			  tituloDesafio:'',
			  avaliacao: ''
          }
      ],
	  totalNotificacao: 0,
	  minhaResposta: '',
	  respostaDesafio: [
		  {
            desafio: '',
            idDesafio: '',
            matriculaDesafiado: '',
            matriculaDesafiante: '',
            respostaDesafiado: '',
            resultado: '',
			tituloDesafio:'',
			avaliacao: ''
          }
	  ],
	  headersDesafiosCorrecao: [
            {
              align: 'left',
              sortable: false,
            },
            // { key: 'idDesafio', label: 'Prioridade Desafio' },
            { key: 'tituloDesafio', label: 'Título' },
            { key: 'desafio', label: 'Desafio' },
            { key: 'respostaDesafiado', label: 'Resposta do desafiado', sortable: true },
            { key: 'resultado', label: 'Sua correção' , sortable: true  } 
	   ],
	   desafiosCorrecao: [
		  {
            desafio: '',
            idDesafio: '',
            matriculaDesafiado: '',
            matriculaDesafiante: '',
            respostaDesafiado: '',
            resultado: '',
			tituloDesafio:'',
			avaliacao: ''
          }
	  ],
	  correcaoAvalia: '',
	  correcaoOpcao: ''
    }
  },
  computed: {
    rows() {
      return this.desafios.length
	},
	rowDesafio(){
		return this.usuarios.length
	},
	rowsCorrecao(){
		return this.desafiosCorrecao.length
	}
  },
created : function(){
    const vm = this;
	vm.todosUsuarios();
	vm.meusDesafios();
	vm.desafiosCorrigir();
  },
  methods : {
	avalia: function(item){
		const vm = item;
		const context = this;
		context.respostaDesafio = vm;
		$("#modalAnalise").modal("show");
	},
	salvaAvaliacao: function(){
		const vm = this;
		if(vm.respostaDesafio.resultado == 'Aguardando sua correção' && vm.respostaDesafio.respostaDesafiado != 'Desafiado ainda não respondeu'){
			vm.respostaDesafio.avaliacao = vm.correcaoAvalia;
			vm.respostaDesafio.resultado = vm.correcaoOpcao;
			axios.post('../rs/desafio/salvaAvaliacao', vm.respostaDesafio).then(function(response){
				if(response.data == true){
					$("#feedbackAvalia").modal("show");
					vm.atualizaPontuacao(100);
					vm.desafiosCorrigir();
				}
			});
		} else if (vm.respostaDesafio.respostaDesafiado == 'Desafiado ainda não respondeu'){
			alert("O desafiado ainda não respondeu a este desafio!");
		} else {
			alert("Você já avaliou este desafio!");
		}
	},
	verificaCampos : function (){
            const vm = this;

            vm.mensagens = [];
          
            var isOk = 1;
            if(vm.respostaDesafio.resposta.length <= 1){
              vm.mensagens.push('Digite uma resposta válida. A resposta deve conter no mínimo 1 caracter.');
            }
            
            for(var a = 0; a < vm.mensagens.length; a++){
              if(vm.mensagens[a] != null){
                demo.novaMensagem(vm.mensagens[a], 4);
                demo.showNotification();
              }
            }

            if(parseInt(vm.mensagens.length) > 0){
              isOk = 0;
            }
            return isOk;
	},
	desafiosCorrigir: function(){
		const vm = this;
		var count = 0;
		axios.get('../rs/user/getUser').then(function(response){
            axios.get('../rs/desafio/desafiosCorrecao/'+response.data["matricula"]).then(function(response){
				while(response.data[count]){
                    if(response.data[count]['resultado'] == '' || response.data[count]['resultado'] == null){
                        response.data[count]['resultado'] = 'Aguardando sua correção';
                    }

                    if(response.data[count]['respostaDesafiado'] == '' || response.data[count]['respostaDesafiado'] == null){
                        response.data[count]['respostaDesafiado'] = 'Desafiado ainda não respondeu';
					}
					
					if(response.data[count]['resultado'] == 'C'){
                        response.data[count]['resultado'] = 'Correto';
                    } else if(response.data[count]['resultado'] == 'E'){
                        response.data[count]['resultado'] = 'Errado';
					}
                    // response.data[count]["idDesafio"] = count+1;
                    count+=1;
                }
				vm.desafiosCorrecao = response.data;
			});
		});

	},
	meusDesafios: function(){
		const vm = this;
        var count = 0;
        axios.get('../rs/user/getUser').then(function(response){
            axios.get('../rs/desafio/todosDesafios/'+response.data["matricula"]).then(function(response){
                while(response.data[count]){
                    if(response.data[count]['resultado'] == '' || response.data[count]['resultado'] == null){
                        response.data[count]['resultado'] = 'Aguardando correção';
					}
					
					if(response.data[count]['avaliacao'] == '' || response.data[count]['avaliacao'] == null){
                        response.data[count]['avaliacao'] = 'Aguardando feedback';
					}
					
                    if(response.data[count]['respostaDesafiado'] == '' || response.data[count]['respostaDesafiado'] == null){
                        response.data[count]['respostaDesafiado'] = 'Sem resposta';
					}
					
					if(response.data[count]['resultado'] == 'C'){
                        response.data[count]['resultado'] = 'Correto';
                    } else if(response.data[count]['resultado'] == 'E'){
                        response.data[count]['resultado'] = 'Errado';
					}
                    //response.data[count]["idDesafio"] = count+1;
                    // vm.desafios.push(response.data[count]);
                    count+=1;
                }
                vm.totalNotificacao = count;
                vm.desafios = response.data;
            });
        });
	},
	abreModalResposta: function(item){
		const vm = this;
		vm.respostaDesafio = item;
		$("#modalResposta").modal("show");

	},
	responde: function(){
		const vm = this;
		if(vm.respostaDesafio.respostaDesafiado == 'Sem resposta'){
			vm.respostaDesafio.respostaDesafiado = vm.minhaResposta;
			axios.post('../rs/desafio/respondeDesafio/', vm.respostaDesafio).then(function(response) {
				if(response.data == true){
					$("#feedbackResposta").modal("show");
					vm.atualizaPontuacao(100);
				}
			});
		} else {
			alert("Você já respondeu esse desafio!");
		}
    },
    todosUsuarios : function(){
      const vm = this;
      var count = 0;
      var aux = 0;
      var array = [];
  
      axios.get('../rs/user/todosUsuarios/').then(function(response)   {
        array = response.data;
        axios.get('../rs/user/getUser/').then(function(response) {
          vm.matricula = response.data["matricula"];
          while(array[count]){
            if((parseInt(array[count]["matricula"]) != parseInt(vm.matricula)) && (parseInt(array[count]["idTipoPerfil"]) == 3)){
              let obj = {
                posicao: '',
                nomeUsuario: '', 
                matricula: '',
                pontuacao: '',
                idPersonagem: '',
                level: ''
              }
              obj.posicao = aux+1,
              obj.nomeUsuario = array[count]["nomeUsuario"];
              obj.matricula = array[count]["matricula"];
              obj.pontuacao = array[count]["pontuacao"]; 
              obj.idPersonagem = array[count]["idPersonagem"]; 
              obj.level = array[count]["level"]; 
              vm.usuarios.push(obj); 
              aux+=1;
            }
            count+=1;
          }
            vm.totalJogadores = aux;
        });
      });
    },
    atualizaPontuacao: function (valor){
          const vm = this;
          axios.get('../rs/user/getUser/').then(function(response) {
            
            axios.get('../rs/user/atualizaPontuacao/'+(parseInt(response.data["pontuacao"])+parseInt(valor))+'/'+response.data["matricula"]+'/'+response.data["level"]).then(function(response) {              
            });
          });
    },
    batalha: function(user){
      const vm = user;
      const context = this;
      context.desafiado = '../resources/img/persona.png';
      context.desafiante = '../resources/img/persona.png';
      context.matriculaDesafiado = vm.matricula;

      axios.get('../rs/personagem/getPersonagem/'+vm.idPersonagem).then(function(response) {
          context.desafiado = response.data['imgPersonagem'];
        });
      axios.get('../rs/personagem/getPersonagem/'+sessionStorage.getItem('idPersonagem')).then(function(response) {
        context.desafiante = response.data['imgPersonagem'];
      });
      $("#modalBatalha").modal("show"); 
    
    },
    salvaDesafio: function(){
      const vm = this;
      let obj = {
        matriculaDesafiante: vm.matricula,
        matriculaDesafiado: vm.matriculaDesafiado,
        tituloDesafio: vm.tituloDesafio,
        desafio: vm.desafio,
        respostaDesafiado: '',
        resultado: ''
      }
      axios.post('../rs/desafio/novoDesafioX1', obj).then(function(response) {
        console.log(response.data);
        vm.atualizaPontuacao(100);
        $("#pvsp").modal("show");
        const audio = document.querySelector('audio');
        audio.play();
      });  
    }
  }
});


  $(function(){
    $("#menu").load("base.html"); 
    $("#modalInicio").modal("show");
  });
  
  
  </script>



</body>
</html>